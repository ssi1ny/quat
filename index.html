<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dear.toe Brand Kit & Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons Script -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FDFBF7; /* Cream White */
            color: #4A4A4A; /* Charcoal Grey */
        }
        h1, h2, h3, .serif {
            font-family: 'Playfair Display', serif;
        }
        .bg-dusty-pink {
            background-color: #E8D3D3; /* Warm Dusty Pink */
        }
        .text-dusty-pink {
            color: #C5A0A0; /* Warm Darker Pink */
        }
        .border-dusty-pink {
            border-color: #E8D3D3;
        }
        .btn-hover:hover {
            background-color: #D6C0C0;
            transition: all 0.3s ease;
        }
        .tab-active {
            border-bottom: 2px solid #C5A0A0;
            color: #4A4A4A;
            font-weight: 500;
        }
        .tab-inactive {
            color: #9CA3AF;
            border-bottom: 2px solid transparent;
        }
        /* Custom Scrollbar for aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #FDFBF7;
        }
        ::-webkit-scrollbar-thumb {
            background: #E8D3D3;
            border-radius: 4px;
        }
        /* Loading Spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #C5A0A0;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Grid Animation */
        .grid-item-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

    <!-- Header -->
    <header class="text-center mb-10">
        <div class="inline-block p-1 border border-gray-200 rounded-full mb-4">
            <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden relative">
                <div class="absolute inset-0 bg-[#E8D3D3] opacity-30"></div>
                <span class="serif text-2xl italic text-gray-600 z-10">d.t</span>
            </div>
        </div>
        <h1 class="text-4xl font-semibold tracking-wide mb-2">dear.toe</h1>
        <a href="https://www.instagram.com/dear._toe/" target="_blank" class="text-sm text-gray-400 tracking-wide hover:text-dusty-pink transition-colors flex items-center justify-center gap-1">
            <i data-lucide="instagram" class="w-3 h-3"></i> dear._toe
        </a>
    </header>

    <!-- Main Container -->
    <main class="w-full max-w-2xl bg-white shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] rounded-xl overflow-hidden border border-gray-100">
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-100">
            <button onclick="switchTab('guide')" id="tab-guide" class="flex-1 py-4 text-center text-xs sm:text-sm tracking-wide transition-colors tab-active">
                BRAND GUIDE
            </button>
            <button onclick="switchTab('generator')" id="tab-generator" class="flex-1 py-4 text-center text-xs sm:text-sm tracking-wide transition-colors tab-inactive">
                CAPTION MAKER
            </button>
            <button onclick="switchTab('grid')" id="tab-grid" class="flex-1 py-4 text-center text-xs sm:text-sm tracking-wide transition-colors tab-inactive">
                GRID PLANNER
            </button>
        </div>

        <!-- Content: Brand Guide -->
        <div id="content-guide" class="p-8 space-y-8 animate-fade-in">
            <!-- Identity -->
            <section>
                <h2 class="serif text-xl mb-4 italic text-gray-800 flex items-center">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-2 text-dusty-pink"></i> Identity
                </h2>
                <div class="bg-[#FDFBF7] p-6 rounded-lg border border-gray-100 space-y-3 text-sm">
                    <p><span class="font-medium text-gray-600">Concept:</span> ë°œë ˆë¼ëŠ” í™˜ìƒ(Fantasy) & ë¡œë§ì˜ ì‹œê°í™”</p>
                    <p><span class="font-medium text-gray-600">Tone:</span> <span class="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-500">Romantic</span> <span class="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-500">Dreamy</span> <span class="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-500">Chic</span></p>
                </div>
            </section>


            <!-- Image Prompt Builder -->
            <section class="mt-8">
                <h2 class="serif text-xl mb-4 italic text-gray-800 flex items-center">
                    <i data-lucide="image" class="w-4 h-4 mr-2 text-dusty-pink"></i> Image Prompt Builder
                </h2>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 space-y-4">
                    
                    <!-- 1. Subject Input & Translate -->
                    <div>
                        <label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Step 1. Subject (ì›í•˜ëŠ” ì£¼ì œ)</label>
                        <div class="flex gap-2">
                            <input type="text" id="prompt-subject" 
                                class="flex-1 bg-white border border-gray-200 rounded p-3 text-sm text-gray-800 focus:outline-none focus:border-[#C5A0A0] transition-colors placeholder-gray-300"
                                placeholder="ì˜ˆ: í† ìŠˆì¦ˆê°€ ë†“ì¸ ì˜ì (í•œê¸€ ì…ë ¥ í›„ ë²ˆì—­ ê°€ëŠ¥)" oninput="updatePromptPreview()">
                            <button onclick="translateSubject()" class="px-3 bg-white border border-gray-200 rounded text-gray-500 hover:bg-gray-100 hover:text-dusty-pink transition-colors" title="í•œê¸€ì„ ì˜ì–´ë¡œ ë²ˆì—­ (API Key í•„ìš”)">
                                <i data-lucide="languages" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 2. Style Formula (Editable) -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-[10px] text-gray-400 uppercase tracking-wider">Step 2. Style Formula (ìŠ¤íƒ€ì¼ ê³ ì •ê°’)</label>
                            <button onclick="resetFormula()" class="text-[10px] text-gray-400 underline hover:text-red-400">Reset to Default</button>
                        </div>
                        <textarea id="master-prompt" 
                            class="w-full h-24 bg-white border border-gray-200 rounded p-3 text-xs text-gray-500 font-mono focus:outline-none focus:border-[#C5A0A0] transition-colors resize-none leading-relaxed"
                            oninput="updatePromptPreview()"
                            placeholder="ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸..."></textarea>
                        <div class="flex justify-end mt-1">
                             <button onclick="saveFormula()" class="text-[10px] text-dusty-pink hover:text-gray-600 flex items-center py-1 px-2 rounded hover:bg-gray-100 transition-colors">
                                <i data-lucide="save" class="w-3 h-3 mr-1"></i> Save Formula
                            </button>
                        </div>
                    </div>

                    <!-- 3. Full Prompt Output -->
                    <div class="pt-2 border-t border-gray-200">
                        <label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-2">Final Prompt (í´ë¦­í•´ì„œ ë³µì‚¬)</label>
                        <div class="relative bg-gray-800 rounded-lg p-4 group cursor-pointer hover:bg-gray-700 transition-colors" onclick="copyFullPrompt()">
                            <p id="full-prompt-preview" class="text-sm text-gray-300 font-mono break-all leading-relaxed">
                                <span class="text-gray-500 italic">ì£¼ì œë¥¼ ì…ë ¥í•˜ë©´ ì—¬ê¸°ì— ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤...</span>
                            </p>
                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="bg-white text-gray-800 text-[10px] px-2 py-1 rounded font-bold shadow-md">Copy</span>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
        </div>

        <!-- Content: Caption Generator -->
        <div id="content-generator" class="hidden p-8 space-y-8 animate-fade-in">
            <div class="text-center space-y-2 mb-8">
                <h2 class="serif text-2xl italic text-gray-800">Caption Maker</h2>
                <p class="text-xs text-gray-400 font-light">Enter description, get aesthetic caption only.</p>
            </div>

            <!-- API Key Section (Always Open & Pre-filled) -->
            <div class="mb-8 border border-[#E8D3D3] rounded-lg overflow-hidden">
                <div class="flex justify-between items-center p-3 bg-[#FDFBF7]">
                    <span class="flex items-center text-xs text-gray-500">
                        <i data-lucide="key" class="w-3 h-3 mr-2"></i> Google Gemini API ì„¤ì •
                    </span>
                    <!-- Toggle Switch (Off by default) -->
                    <button id="apiToggleBtn" onclick="toggleApiState()" class="w-8 h-4 rounded-full bg-[#C5A0A0] relative transition-colors focus:outline-none">
                        <div id="apiToggleCircle" class="w-3 h-3 rounded-full bg-white shadow-sm absolute top-0.5 left-0.5 transition-transform translate-x-4"></div>
                    </button>
                </div>
                
                <div id="apiKeySection" class="bg-white p-4 border-t border-[#E8D3D3]">
                    <div class="text-[11px] text-gray-400 mb-2 mt-2 leading-relaxed">
                        API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ Geminiê°€ ì§ì ‘ ê¸€ì„ ì‘ì„±í•´ì¤ë‹ˆë‹¤.<br>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-dusty-pink underline hover:text-gray-600">Google AI Studioì—ì„œ í‚¤ ë°œê¸‰ë°›ê¸° â†’</a>
                    </div>
                    <div class="flex gap-2">
                        <input type="password" id="userApiKey" placeholder="AI..." value="AIzaSyA3fBToKjFIE7org-fUhsGVmQYX8qhdIX0"
                            class="flex-1 bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs focus:outline-none focus:border-[#C5A0A0] transition-colors">
                        <button onclick="saveApiKey()" class="px-4 bg-gray-800 text-white text-xs rounded hover:bg-gray-700 transition-colors shadow-sm whitespace-nowrap">
                            Save
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Photo Situation / Keyword</label>
                    <input type="text" id="userInput" placeholder="ì˜ˆ: ë°œë ˆ í† ìŠˆì¦ˆ ì‚¬ì§„" 
                        class="w-full bg-[#FDFBF7] border border-gray-200 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-[#C5A0A0] transition-colors placeholder-gray-300">
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Language</label>
                            <div class="flex gap-2">
                                <button onclick="setLanguage('ko')" id="lang-ko" class="flex-1 py-2 text-xs border border-[#C5A0A0] bg-[#E8D3D3] text-gray-700 rounded transition-colors">Korean</button>
                                <button onclick="setLanguage('en')" id="lang-en" class="flex-1 py-2 text-xs border border-gray-200 text-gray-400 rounded hover:bg-gray-50 transition-colors">English</button>
                            </div>
                        </div>
                        <div class="flex-1">
                             <label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Style</label>
                             <div class="flex items-center h-[34px]">
                                <input type="checkbox" id="aestheticFont" class="w-4 h-4 text-dusty-pink border-gray-300 rounded focus:ring-dusty-pink" checked>
                                <label for="aestheticFont" class="ml-2 text-xs text-gray-600 cursor-pointer select-none">âœ¨ Aesthetic Font ì ìš©</label>
                             </div>
                        </div>
                    </div>
                    <button onclick="handleGenerate()" id="generateBtn" class="w-full h-[42px] bg-gray-800 text-white text-xs tracking-wider rounded hover:bg-gray-700 transition-colors shadow-sm flex items-center justify-center">
                        GENERATE
                    </button>
                </div>
            </div>

            <!-- Output Area -->
            <div id="resultArea" class="hidden space-y-6 pt-4 border-t border-gray-100">
                <!-- Variations will be injected here -->
                <div class="space-y-2">
                    <div class="flex justify-between items-end"><span class="text-xs text-dusty-pink font-medium">Option A</span><button onclick="copyOutput('result1')" class="text-[10px] text-gray-400 hover:text-gray-600 underline">COPY</button></div>
                    <div class="bg-[#FDFBF7] p-4 rounded-lg border border-gray-100"><p id="result1" class="text-sm text-gray-700 leading-relaxed font-light whitespace-pre-wrap"></p></div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-end"><span class="text-xs text-dusty-pink font-medium">Option B</span><button onclick="copyOutput('result2')" class="text-[10px] text-gray-400 hover:text-gray-600 underline">COPY</button></div>
                    <div class="bg-[#FDFBF7] p-4 rounded-lg border border-gray-100"><p id="result2" class="text-sm text-gray-700 leading-relaxed font-light whitespace-pre-wrap"></p></div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-end"><span class="text-xs text-dusty-pink font-medium">Option C</span><button onclick="copyOutput('result3')" class="text-[10px] text-gray-400 hover:text-gray-600 underline">COPY</button></div>
                    <div class="bg-[#FDFBF7] p-4 rounded-lg border border-gray-100"><p id="result3" class="text-sm text-gray-700 leading-relaxed font-light whitespace-pre-wrap"></p></div>
                </div>
            </div>
        </div>

        <!-- Content: Grid Planner -->
        <div id="content-grid" class="hidden p-8 space-y-8 animate-fade-in">
            <div class="text-center space-y-2 mb-8">
                <h2 class="serif text-2xl italic text-gray-800">Grid Planner</h2>
            </div>

            <!-- Feed Formula Tips -->
            <div class="bg-gray-50 p-5 rounded-lg border border-gray-100 mb-8">
                <h3 class="serif text-sm italic text-gray-800 flex items-center mb-3">
                    <i data-lucide="lightbulb" class="w-3 h-3 mr-2 text-dusty-pink"></i> Feed Formula
                </h3>
                <div class="grid grid-cols-3 gap-2 text-center mb-4">
                    <div class="space-y-1">
                        <div class="text-[10px] font-medium text-gray-600">Look</div>
                        <div class="text-[9px] text-gray-400">ì „ì‹  / ë°˜ì‹ <br>(ì–¼êµ´ ì—†ëŠ” ìƒ·)</div>
                    </div>
                    <div class="space-y-1">
                        <div class="text-[10px] font-medium text-dusty-pink">Detail</div>
                        <div class="text-[9px] text-gray-400">í† ìŠˆì¦ˆ / ë¦¬ë³¸<br>ë ˆì´ìŠ¤ ì§ˆê° í™•ëŒ€</div>
                    </div>
                    <div class="space-y-1">
                        <div class="text-[10px] font-medium text-gray-500">Space</div>
                        <div class="text-[9px] text-gray-400">í–‡ì‚´ ë“  ì°½ê°€<br>ë¹ˆí‹°ì§€ ì†Œí’ˆ</div>
                    </div>
                </div>
                <div class="bg-white p-3 rounded border border-gray-100 text-[10px] text-gray-500 leading-relaxed">
                    <strong class="text-dusty-pink">Color Tip:</strong><br>
                    ë”ìŠ¤í‹° í•‘í¬ ëŒ€ì‹  <strong class="text-gray-700">ë¹ˆí‹°ì§€ ë² ì´ë¹„ í•‘í¬</strong>ì™€ <strong class="text-gray-700">í¬ë¦¼</strong>ìƒ‰ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                </div>
            </div>

            <!-- Controls -->
            <div class="flex gap-2 justify-center mb-6">
                <button onclick="addGridItem('look')" class="flex flex-col items-center justify-center w-20 h-20 bg-white border border-gray-200 rounded-lg hover:border-[#E8D3D3] hover:shadow-sm transition-all">
                    <i data-lucide="user" class="w-5 h-5 text-gray-600 mb-1"></i>
                    <span class="text-[10px] text-gray-500">Look</span>
                </button>
                <button onclick="addGridItem('detail')" class="flex flex-col items-center justify-center w-20 h-20 bg-[#FDFBF7] border border-gray-200 rounded-lg hover:border-[#E8D3D3] hover:shadow-sm transition-all">
                    <i data-lucide="sparkles" class="w-5 h-5 text-dusty-pink mb-1"></i>
                    <span class="text-[10px] text-gray-500">Detail</span>
                </button>
                <button onclick="addGridItem('space')" class="flex flex-col items-center justify-center w-20 h-20 bg-gray-50 border border-gray-200 rounded-lg hover:border-[#E8D3D3] hover:shadow-sm transition-all">
                    <i data-lucide="sun" class="w-5 h-5 text-gray-400 mb-1"></i>
                    <span class="text-[10px] text-gray-500">Space</span>
                </button>
            </div>

            <!-- Grid Display -->
            <div id="feedGrid" class="grid grid-cols-3 gap-1 max-w-[350px] mx-auto bg-white border border-gray-100 p-1 rounded">
                <!-- Grid Items will be rendered here -->
            </div>

            <!-- Reset Button with Confirmation State -->
            <div class="text-center mt-4 mb-8">
                <button id="btnResetGrid" onclick="handleResetGrid(this)" class="text-[10px] text-gray-400 underline hover:text-red-400 transition-colors">Reset Grid</button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-[#F9F7F5] py-4 text-center border-t border-gray-100">
            <p class="text-[10px] text-gray-400 uppercase tracking-widest">Designed for dear.toe</p>
        </footer>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-6 py-3 rounded-full shadow-lg opacity-0 pointer-events-none transition-opacity duration-300">
        Copied to clipboard
    </div>

    <script>
        // Ensure Lucide is loaded
        window.addEventListener('load', function() {
            if (window.lucide) {
                lucide.createIcons();
                
                // Load saved formula
                loadFormula();
                // Load grid
                renderGrid(); 
                // Load Saved API Key
                loadApiKey();
            }
        });

        // --- Common State & Functions ---
        let currentLang = 'ko';
        let isApiMode = true; // Default to API Mode = ON

        function switchTab(tabName) {
            const tabs = ['guide', 'generator', 'grid'];
            tabs.forEach(t => {
                const content = document.getElementById(`content-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if (t === tabName) {
                    content.classList.remove('hidden');
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                } else {
                    content.classList.add('hidden');
                    btn.classList.add('tab-inactive');
                    btn.classList.remove('tab-active');
                }
            });
            setTimeout(() => lucide.createIcons(), 50);
        }

        function setLanguage(lang) {
            currentLang = lang;
            const btnKo = document.getElementById('lang-ko');
            const btnEn = document.getElementById('lang-en');
            if (lang === 'ko') {
                btnKo.classList.add('bg-[#E8D3D3]', 'border-[#C5A0A0]', 'text-gray-700');
                btnKo.classList.remove('text-gray-400', 'hover:bg-gray-50', 'border-gray-200');
                btnEn.classList.remove('bg-[#E8D3D3]', 'border-[#C5A0A0]', 'text-gray-700');
                btnEn.classList.add('text-gray-400', 'border-gray-200');
            } else {
                btnEn.classList.add('bg-[#E8D3D3]', 'border-[#C5A0A0]', 'text-gray-700');
                btnEn.classList.remove('text-gray-400', 'hover:bg-gray-50', 'border-gray-200');
                btnKo.classList.remove('bg-[#E8D3D3]', 'border-[#C5A0A0]', 'text-gray-700');
                btnKo.classList.add('text-gray-400', 'border-gray-200');
            }
        }

        // --- Clipboard Helper Function ---
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) showToast("Copied to clipboard");
            } catch (err) {
                console.error('Fallback copy failed', err);
            }
            document.body.removeChild(textarea);
        }

        function copyText(element, targetId) {
            const text = document.getElementById(targetId).innerText; 
            copyToClipboard(text);
        }
        
        function copyOutput(targetId) {
            const text = document.getElementById(targetId).innerText;
            copyToClipboard(text);
        }

        function showToast(message = "Copied to clipboard") {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function toggleApiKeySection() {
            const section = document.getElementById('apiKeySection');
            const chevron = document.getElementById('api-chevron');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        // --- API Toggle Switch Logic ---
        function toggleApiState() {
            isApiMode = !isApiMode;
            const btn = document.getElementById('apiToggleBtn');
            const circle = document.getElementById('apiToggleCircle');
            const section = document.getElementById('apiKeySection');

            if (isApiMode) {
                // ON state
                btn.classList.remove('bg-gray-300');
                btn.classList.add('bg-[#C5A0A0]'); // Warm pink
                circle.classList.add('translate-x-4');
                section.classList.remove('hidden');
            } else {
                // OFF state
                btn.classList.remove('bg-[#C5A0A0]');
                btn.classList.add('bg-gray-300');
                circle.classList.remove('translate-x-4');
                section.classList.add('hidden');
            }
        }

        // --- API Key Management ---
        const API_KEY_STORAGE = 'dearToeApiKey';

        function loadApiKey() {
            const savedKey = localStorage.getItem(API_KEY_STORAGE);
            if (savedKey) {
                const input = document.getElementById('userApiKey');
                if(input) input.value = savedKey;
            }
            // Ensure section is open if in API mode (default)
            if (isApiMode) {
                document.getElementById('apiKeySection').classList.remove('hidden');
            }
        }

        function saveApiKey() {
            const key = document.getElementById('userApiKey').value.trim();
            if (!key) {
                alert("API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            localStorage.setItem(API_KEY_STORAGE, key);
            showToast("API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // --- Image Formula Storage Logic ---
        const DEFAULT_FORMULA = ", soft bright mute mood, vintage-inspired feminine aesthetic, airy and luminous atmosphere, coquette balletcore vibe, dreamy and hazy feeling, soft diffused morning light, subtle film grain, gentle motion blur, nostalgic pinterest-style photography, clean and light overall tone, soft glow, minimal contrast, --ar 9:16 --stylize 250";
        const FORMULA_STORAGE_KEY = 'dearToeFormula';

        function loadFormula() {
            const saved = localStorage.getItem(FORMULA_STORAGE_KEY);
            const masterPrompt = document.getElementById('master-prompt');
            if(masterPrompt) {
                masterPrompt.value = saved || DEFAULT_FORMULA;
                updatePromptPreview();
            }
        }

        function saveFormula() {
            const masterPrompt = document.getElementById('master-prompt');
            if(!masterPrompt) return;
            const current = masterPrompt.value;
            localStorage.setItem(FORMULA_STORAGE_KEY, current);
            showToast("Formula Saved");
            updatePromptPreview();
        }

        function copyFormula() {
            const masterPrompt = document.getElementById('master-prompt');
            if(!masterPrompt) return;
            copyToClipboard(masterPrompt.value);
        }

        function resetFormula() {
            if(confirm("ê¸°ë³¸ ì„¤ì •ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const masterPrompt = document.getElementById('master-prompt');
                if(!masterPrompt) return;
                masterPrompt.value = DEFAULT_FORMULA;
                saveFormula();
            }
        }

        // --- Prompt Builder Logic ---
        function updatePromptPreview() {
            const subjectEl = document.getElementById('prompt-subject');
            const formulaEl = document.getElementById('master-prompt');
            const previewEl = document.getElementById('full-prompt-preview');
            
            if (!subjectEl || !formulaEl || !previewEl) return;

            const subject = subjectEl.value.trim();
            const formula = formulaEl.value.trim();
            
            if (!subject) {
                previewEl.innerHTML = `<span class="text-gray-500 italic">ì£¼ì œë¥¼ ì…ë ¥í•˜ë©´ ì—¬ê¸°ì— ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤...</span>`;
                return;
            }
            
            let combined = subject;
            if (formula) {
                if (!subject.endsWith(',') && !formula.startsWith(',')) {
                    combined += ", ";
                }
                combined += formula;
            }
            
            previewEl.innerText = combined;
        }

        function copyFullPrompt() {
            const previewEl = document.getElementById('full-prompt-preview');
            if(!previewEl) return;
            if (previewEl.querySelector('span')) {
                alert("ì£¼ì œë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”!");
                return;
            }
            copyToClipboard(previewEl.innerText);
        }

        // --- Translation Logic ---
        async function translateSubject() {
            const subjectEl = document.getElementById('prompt-subject');
            if (!subjectEl) return;
            const text = subjectEl.value.trim();
            if (!text) {
                alert("ë²ˆì—­í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const apiKey = document.getElementById('userApiKey').value.trim();
            if (!apiKey) {
                alert("ë²ˆì—­ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ API Keyë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            // Simple visual feedback
            const originalPlaceholder = subjectEl.placeholder;
            subjectEl.placeholder = "Translating...";
            
            try {
                // UPDATED: Using stable version 
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Translate the following short text to English for use in an image generation prompt. Output ONLY the English translation without any extra words or quotes.\n\nInput: ${text}`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const translation = data.candidates[0].content.parts[0].text.trim();
                subjectEl.value = translation;
                updatePromptPreview();
                showToast("Translated!");

            } catch (error) {
                console.error("Translation failed:", error);
                alert("ë²ˆì—­ ì‹¤íŒ¨: " + error.message);
            } finally {
                subjectEl.placeholder = originalPlaceholder;
            }
        }

        // --- Aesthetic Font Logic ---
        function toAestheticFont(text) {
            return text.split('').map(char => {
                const code = char.charCodeAt(0);
                if (code >= 65 && code <= 90) return String.fromCodePoint(0x1D434 + code - 65);
                if (code >= 97 && code <= 122) {
                    if (char === 'h') return 'â„'; 
                    return String.fromCodePoint(0x1D44E + code - 97);
                }
                return char;
            }).join('');
        }

        function applyStyle(text) {
            const aestheticCheckbox = document.getElementById('aestheticFont');
            if (!aestheticCheckbox || !aestheticCheckbox.checked) return text;
            return text.split(/(\s+)/).map(word => {
                if (word.startsWith('#')) return word;
                return toAestheticFont(word);
            }).join('');
        }

        // --- Aesthetic Decorations ---
        const aestheticAtoms = [
            "ğ“‚ƒ", "Ë–", "Ë³", "Â·", "Ö´Ö¶Ö¸", "â‹†", "Ëš", "âœ§", "â‚Š", "à­¨à­§", "âŸ¡", "ï½¡", "ğœ—ğœš", "âŠ¹", "â€§", "ğ–¥”", "İ", ".", "ãƒ»", "ã‚œ", "ï¹’", "ï¼",
            "â­‘", "â™¢", "ğ“†©", "â™¡", "ğ“†ª", "â¸", "ê’°", "â£", "âº", "ê’±", "â¥", "â”ˆ", "à¼š", "à¼…", "â", "â›§", "ê™³", "â­’", "â˜ªï¸", "ï¼Š", "ğ“¯", "ğ“²", "ğ“†¸"
        ];
        const balletEmojis = ["ğŸ©°", "ğŸ¦¢", "â˜ï¸", "ğŸ€", "ğŸ•Šï¸", "ğŸ¤", "ğŸª½", "ğŸ—ï¸", "ğŸ—ï¸", "ğŸª", "ğŸ•¯ï¸", "ğŸ°", "ğŸ", "ğŸ«§", "ğŸ§", "ğŸ§šâ€â™€ï¸", "ğŸ¹", "ğŸ»", "ğŸˆ"];

        // Function to generate complex decoration patterns
        function applyAdvancedDecoration(text) {
            const r = Math.random();
            const atom1 = aestheticAtoms[Math.floor(Math.random() * aestheticAtoms.length)];
            const atom2 = aestheticAtoms[Math.floor(Math.random() * aestheticAtoms.length)];
            const atom3 = aestheticAtoms[Math.floor(Math.random() * aestheticAtoms.length)];
            
            if (r < 0.3) {
                return `${text} ${atom1}`;
            }
            else if (r < 0.6) {
                return `${text} ${atom1}${atom2}${atom3}`;
            }
            else if (r < 0.8) {
                return `${atom1} ${text} ${atom1}`;
            }
            else {
                const patterns = [
                    `ê’° ${atom1} . âº . ${atom1} . âº . ${atom1} ê’±\n${text}`,
                    `Ëšâ‚Šâ€§Â° ${atom1} ğ“†©â™¡ğ“†ª ${atom1} Â°â€§â‚ŠËš\n${text}`,
                    `â¥ãƒ»ãƒ» â”ˆâ”ˆâ”ˆ ${atom1} à­¨à­§ ${atom1} â”ˆâ”ˆâ”ˆ ãƒ»ãƒ»â¥\n${text}`,
                    `${text}\nâ‹†Ë™âŸ¡ ${atom1} Ëšï½¡â‹†à­¨à­§Ëš ğœ—ğœš âŠ¹ â€§â‚ŠËš`
                ];
                return patterns[Math.floor(Math.random() * patterns.length)];
            }
        }

        function getDecoration() {
             return aestheticAtoms[Math.floor(Math.random() * aestheticAtoms.length)];
        }

        // --- Grid Planner Logic ---
        const GRID_STORAGE_KEY = 'dearToeGrid';
        let resetTimeout; 
        
        function getGrid() {
            const saved = localStorage.getItem(GRID_STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
        }

        function saveGrid(grid) {
            localStorage.setItem(GRID_STORAGE_KEY, JSON.stringify(grid));
            renderGrid();
        }

        function addGridItem(type) {
            const grid = getGrid();
            
            // Expanded Subtitle Pools - Updated per request
            const subtitles = {
                'look': [
                    "ì „ì‹  (ì–¼êµ´X)", "ë°˜ì‹  (ê±°ìš¸ ì…€ì¹´)", "ë’·ëª¨ìŠµ (ë“± ë¼ì¸)", "ê³ ì „ ëª…í™”í’ ë°œë ˆë¦¬ë‚˜", "ë¹ˆí‹°ì§€ ë°œë ˆ ì‚¬ì§„", 
                    "ë“œê°€(Degas) ìŠ¤íƒ€ì¼", "ë¬´ëŒ€ ë’¤ ìŠ¤ëƒ…", "ë°œë ˆë°” ì¡ê³ ", "í”Œë¦¬ì— (PliÃ©)", "ë°”ëœ¨ë§ (Battement)", "ì•„ë¼ë² ìŠ¤í¬ (Arabesque)", "ì—í‹°íŠœë“œ (Attitude)", "ì•™ë°”/ì•„ë‚˜ë°© (Port de bras)", "ì‰ë„¤ (ChaÃ®nÃ©s)", "ìš°ì•„í•œ ë„¥ë¼ì¸"
                ],
                'detail': [
                    "í† ìŠˆì¦ˆ ì•ì½” í™•ëŒ€", "í† ìŠˆì¦ˆ ì‹ ì€ ë°œë", "ë¦¬ë³¸ ë¬¶ëŠ” ì†", "ë°œë ˆ ì„œì  (ë™ì‘ ê·¸ë¦¼)", "í¼ì³ì§„ ì˜›ë‚  ì•…ë³´",
                    "ìƒˆí‹´ ê´‘íƒ", "ë ˆì´ìŠ¤ ë””í…Œì¼", "ì§„ì£¼/ì•…ì„¸ì‚¬ë¦¬", "ë§ˆë¥¸ ì¥ë¯¸", "ì‰¬í° ì£¼ë¦„", 
                    "ë²—ì–´ë‘” í† ìŠˆì¦ˆ", "í† ìŠˆì¦ˆ ëˆ í’€ë¦°"
                ],
                'space': [
                    "í–‡ì‚´ ê°€ë“ ì°½ê°€", "ë¹ˆ ì—°ìŠµì‹¤", "ë‚˜ë¬´ ë°”ë‹¥", "ë†“ì—¬ì§„ íŠœíŠœ", "ì°½ë°– í’ê²½", 
                    "ì˜¤í›„ 4ì‹œì˜ ë¹›", "ì—”í‹± ê°€êµ¬", "ê±°ìš¸ ì•", "ì»¤íŠ¼ ì‚¬ì´ ë¹›", "ì •ë¦¬ëœ ì˜·ê°€ì§€",
                    "í† ìŠˆì¦ˆ ê°€ë°©", "ê½ƒë³‘", "ë¨¼ì§€ ìŒ“ì¸ ì°½", "ë”°ëœ»í•œ ì¡°ëª…"
                ]
            };

            const pool = subtitles[type] || [];
            const randomSubtitle = pool.length > 0 ? pool[Math.floor(Math.random() * pool.length)] : type.toUpperCase();

            const newItem = {
                id: Date.now(),
                type: type,
                subtitle: randomSubtitle, 
                timestamp: new Date().toISOString()
            };
            grid.unshift(newItem);
            saveGrid(grid);
        }

        function removeGridItem(id) {
            const grid = getGrid();
            const newGrid = grid.filter(item => item.id !== id);
            saveGrid(newGrid);
        }

        function handleResetGrid(btn) {
            if (btn.innerText === "Confirm Reset?") {
                localStorage.removeItem(GRID_STORAGE_KEY);
                renderGrid();
                btn.innerText = "Reset Grid";
                btn.classList.remove('text-red-500', 'font-bold');
                clearTimeout(resetTimeout);
            } else {
                btn.innerText = "Confirm Reset?";
                btn.classList.add('text-red-500', 'font-bold');
                resetTimeout = setTimeout(() => {
                    btn.innerText = "Reset Grid";
                    btn.classList.remove('text-red-500', 'font-bold');
                }, 3000);
            }
        }

        function renderGrid() {
            const grid = getGrid();
            const container = document.getElementById('feedGrid');
            
            if (grid.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 py-10 text-center text-gray-300 text-xs">
                        <i data-lucide="layout-grid" class="w-6 h-6 mx-auto mb-2 opacity-30"></i>
                        Empty Grid<br>Add blocks to plan
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = grid.map(item => {
                let icon, bgColor, label;
                switch(item.type) {
                    case 'look': icon = 'user'; bgColor = 'bg-white'; break;
                    case 'detail': icon = 'sparkles'; bgColor = 'bg-[#E8D3D3]/20'; break;
                    case 'space': icon = 'sun'; bgColor = 'bg-gray-50'; break;
                }
                
                return `
                    <div class="relative aspect-[4/5] ${bgColor} border border-gray-100 flex flex-col items-center justify-center group cursor-pointer grid-item-enter hover:opacity-90 transition-opacity" onclick="removeGridItem(${item.id})">
                        <i data-lucide="${icon}" class="w-4 h-4 text-gray-400 mb-1"></i>
                        <span class="text-[10px] text-gray-600 font-medium text-center px-1 break-keep">${item.subtitle}</span>
                        <div onclick="removeGridItem(${item.id}); event.stopPropagation();" 
                             class="absolute top-1 right-1 w-5 h-5 flex items-center justify-center bg-white/80 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-50">
                            <i data-lucide="x" class="w-3 h-3 text-red-400"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        // --- Generator Logic ---
        function getRandomTags() {
            const baseTags = "#ë°œë ˆ #ballet";
            const tagPool = ["#dear_toe", "#ë°œë ˆì½”ì–´", "#ì·¨ë¯¸ë°œë ˆ", "#ë°œë ˆìŠ¤íƒ€ê·¸ë¨", "#í† ìŠˆì¦ˆ", "#ê°ì„±ì‚¬ì§„", "#ë¬´ë“œë³´ë“œ", "#balletcore", "#balletaesthetic", "#softgirl", "#dreamyaesthetic", "#ë ˆì˜¤íƒ€ë“œ", "#ootd"];
            const shuffled = tagPool.sort(() => 0.5 - Math.random());
            return `${baseTags} ${shuffled.slice(0, 3).join(' ')}`;
        }

        function generateWithTemplate(input) {
            const tags = getRandomTags();
            let opt1, opt2, opt3;

            if (currentLang === 'ko') {
                const phrases = ["ê°€ì¥ ë‚˜ë‹¤ì›Œì§€ëŠ” ì‹œê°„.", "ì™„ë²½í•œ ì•„ë¼ë² ìŠ¤í¬ë¥¼ ìœ„í•´.", "ë°œë ˆê°€ ì£¼ëŠ” ìœ„ë¡œ.", "ì˜¤ëŠ˜ì˜ ë¬´ë“œ.", "í˜¸í¡ì„ ê°€ë‹¤ë“¬ê³ .", "ìš°ì•„í•¨ì˜ ì¡°ê°.", "ë‚˜ë§Œì˜ ë¦¬ë“¬.", "ê¿ˆê¾¸ëŠ” ë°œë ˆë¦¬ë‚˜.", "ì—°ìŠµì‹¤ì˜ ê³ ìš”í•¨ì´ ì¢‹ë‹¤.", "Pas de deux.", "Reverence.", "Adagio.", "Glimmer.", "Hazy mood.", "Silhouette."];
                const phrase = phrases[Math.floor(Math.random() * phrases.length)];
                
                const raw1 = phrase; 
                const raw2 = `ì´ ìˆœê°„ì˜ ìš°ì•„í•¨`;
                const raw3 = `ê¿ˆê¾¸ë˜ ì¥ë©´`;

                // Korean: No Atoms, Optional Emoji Only (50% chance)
                const getKoDeco = () => Math.random() > 0.5 ? " " + balletEmojis[Math.floor(Math.random() * balletEmojis.length)] : "";

                opt1 = `${raw1}${getKoDeco()}\n.\n${tags}`;
                opt2 = `${raw2}${getKoDeco()}\n.\n${tags}`;
                opt3 = `${raw3}${getKoDeco()}\n.\n${tags}`;
            } else {
                // English: Expanded Phrases (v15.0)
                const phrases = [
                    "Soft layers", "En pointe", "Silence", "Mood", "Grand PliÃ©", "Morning light", "Pure lines", "Tendu", "Satin mood", "Ethereal", "Tulle dreams", "Graceful", "Adagio", "Swan lake", "Ballerina soul", 
                    "Swan Lake", "Giselle", "The Nutcracker", "Sleeping Beauty", "CoppÃ©lia", "Don Quixote", 
                    "Grand JetÃ©", "Pirouette", "Adagio", "Arabesque", "Attitude", "PliÃ©", "Tendu"
                ];
                const phrase = phrases[Math.floor(Math.random() * phrases.length)];
                
                const raw1 = phrase;
                const raw2 = `Satin mood`;
                const raw3 = `Attitude`;

                // English gets fancy decorations (Advanced)
                opt1 = `${applyAdvancedDecoration(applyStyle(raw1))}\n.\n${tags}`;
                opt2 = `${applyAdvancedDecoration(applyStyle(raw2))}\n.\n${tags}`;
                opt3 = `${applyAdvancedDecoration(applyStyle(raw3))}\n.\n${tags}`;
            }

            document.getElementById('result1').innerText = opt1;
            document.getElementById('result2').innerText = opt2;
            document.getElementById('result3').innerText = opt3;
        }

        async function generateWithAI(input, apiKey) {
            const langInstruction = currentLang === 'ko' ? "Use Korean." : "Use English.";
            const systemPrompt = `You are the editor of 'dear.toe', an aesthetic ballet archive Instagram account. Tone: Dry, Chic, Minimalist but dreamy. Rules: Decorations (emojis/symbols) are optional. Add them randomly (about 50% chance). Short (2-3 lines). No greetings. ${langInstruction}. STRICT RULE: Do NOT mix languages in the caption text. For both Korean and English captions, do NOT use a period (.) at the end. 
            
            For Korean captions: Focus on expressing "why I love ballet" or "why this specific moment is beautiful". Use subjective, emotional language (e.g., "The comfort of the studio air", "Striving for the perfect line", "This moment of silence"). Actively mix in ballet terminology (e.g., PliÃ©, Tendu, Arabesque, Adagio, Reverence) or aesthetic keywords (e.g., Satin, Tulle, Hazy, Glimmer) even in Korean text context to sound professional and chic. Avoid generic descriptions.
            
            IMPORTANT: Do NOT repeat the user's input description in the output. Use it only as context. Provide 3 distinct options separated by '|||'. Input description: ${input}`;
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: `${systemPrompt}\n\nGenerate 3 options.` }] }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const rawText = data.candidates[0].content.parts[0].text;
            const options = rawText.split('|||');
            const tags = getRandomTags();
            
            const processOption = (text) => {
                let cleanText = text ? text.replace(/\*\*/g, '').trim() : "AI Error";
                if (cleanText.endsWith('.')) cleanText = cleanText.slice(0, -1);
                
                const styledText = applyStyle(cleanText);
                
                // Apply advanced decoration randomly
                if (Math.random() < 0.7) {
                    return applyAdvancedDecoration(styledText);
                } else {
                    const randomEmoji = balletEmojis[Math.floor(Math.random() * balletEmojis.length)];
                    return `${styledText} ${randomEmoji}`;
                }
            };

            document.getElementById('result1').innerText = processOption(options[0]) + `\n.\n${tags}`;
            document.getElementById('result2').innerText = processOption(options[1] || options[0]) + `\n.\n${tags}`;
            document.getElementById('result3').innerText = processOption(options[2] || options[0]) + `\n.\n${tags}`;
        }

        async function handleGenerate() {
            const input = document.getElementById('userInput').value.trim();
            const apiKey = document.getElementById('userApiKey') ? document.getElementById('userApiKey').value.trim() : '';
            const btn = document.getElementById('generateBtn');
            const resultArea = document.getElementById('resultArea');
            
            if (!input) {
                alert("í‚¤ì›Œë“œë‚˜ ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;

            try {
                if (isApiMode && apiKey) {
                    await generateWithAI(input, apiKey);
                } else {
                    generateWithTemplate(input);
                }
                resultArea.classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                btn.innerHTML = 'GENERATE';
                btn.disabled = false;
            }
        }

        document.getElementById('userInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') handleGenerate();
        });
    </script>
</body>
</html>
