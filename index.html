<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dear.toe Brand Kit & Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons Script -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FDFBF7; /* Cream White */
            color: #4A4A4A; /* Charcoal Grey */
        }
        h1, h2, h3, .serif {
            font-family: 'Playfair Display', serif;
        }
        .bg-dusty-pink {
            background-color: #E8D3D3;
        }
        .text-dusty-pink {
            color: #C5A0A0;
        }
        .border-dusty-pink {
            border-color: #E8D3D3;
        }
        .btn-hover:hover {
            background-color: #D6C0C0;
            transition: all 0.3s ease;
        }
        .tab-active {
            border-bottom: 2px solid #C5A0A0;
            color: #4A4A4A;
            font-weight: 500;
        }
        .tab-inactive {
            color: #9CA3AF;
            border-bottom: 2px solid transparent;
        }
        /* Custom Scrollbar for aesthetic */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #FDFBF7;
        }
        ::-webkit-scrollbar-thumb {
            background: #E8D3D3;
            border-radius: 4px;
        }
        /* Loading Spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #C5A0A0;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Grid Animation */
        .grid-item-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

    <!-- Header -->
    <header class="text-center mb-10">
        <div class="inline-block p-1 border border-gray-200 rounded-full mb-4">
            <div class="w-24 h-24 rounded-full bg-gray-100 flex items-center justify-center overflow-hidden relative">
                <div class="absolute inset-0 bg-[#E8D3D3] opacity-30"></div>
                <span class="serif text-2xl italic text-gray-600 z-10">d.t</span>
            </div>
        </div>
        <h1 class="text-4xl font-semibold tracking-wide mb-2">dear.toe</h1>
        <p class="text-sm text-gray-500 tracking-widest uppercase">Aesthetic Ballet Archive</p>
    </header>

    <!-- Main Container -->
    <main class="w-full max-w-2xl bg-white shadow-[0_4px_20px_-4px_rgba(0,0,0,0.05)] rounded-xl overflow-hidden border border-gray-100">
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-100">
            <button onclick="switchTab('guide')" id="tab-guide" class="flex-1 py-4 text-center text-xs sm:text-sm tracking-wide transition-colors tab-active">
                BRAND GUIDE
            </button>
            <button onclick="switchTab('generator')" id="tab-generator" class="flex-1 py-4 text-center text-xs sm:text-sm tracking-wide transition-colors tab-inactive">
                CAPTION MAKER
            </button>
            <button onclick="switchTab('grid')" id="tab-grid" class="flex-1 py-4 text-center text-xs sm:text-sm tracking-wide transition-colors tab-inactive">
                GRID PLANNER
            </button>
        </div>

        <!-- Content: Brand Guide -->
        <div id="content-guide" class="p-8 space-y-8 animate-fade-in">
            <!-- Identity -->
            <section>
                <h2 class="serif text-xl mb-4 italic text-gray-800 flex items-center">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-2 text-dusty-pink"></i> Identity
                </h2>
                <div class="bg-[#FDFBF7] p-6 rounded-lg border border-gray-100 space-y-3 text-sm">
                    <p><span class="font-medium text-gray-600">Meaning:</span> ë‚˜ì˜ ë°œë(Toe)ì—ê²Œ ë³´ë‚´ëŠ” í¸ì§€</p>
                    <p><span class="font-medium text-gray-600">Concept:</span> ë°œë ˆë¼ëŠ” í™˜ìƒ(Fantasy) & ë¡œë§ì˜ ì‹œê°í™”</p>
                    <p><span class="font-medium text-gray-600">Persona:</span> ë¡œë§ì„ ìˆ˜ì§‘í•˜ëŠ” ëª½ìƒê°€</p>
                    <p><span class="font-medium text-gray-600">Tone:</span> <span class="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-500">Romantic</span> <span class="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-500">Dreamy</span> <span class="bg-gray-100 px-2 py-0.5 rounded text-xs text-gray-500">Chic</span></p>
                </div>
            </section>

            <!-- Bio Options -->
            <section>
                <h2 class="serif text-xl mb-4 italic text-gray-800 flex items-center">
                    <i data-lucide="user" class="w-4 h-4 mr-2 text-dusty-pink"></i> Bio
                </h2>
                <div class="grid gap-4 text-sm">
                    <!-- Option A (Confirmed) -->
                    <div class="group relative border border-gray-100 rounded-lg p-4 hover:border-[#E8D3D3] transition-colors cursor-pointer" onclick="copyText(this, 'bio1')">
                        <p id="bio1" class="text-gray-600 leading-relaxed text-center">ë°œë ˆ | ë¬´ë“œ | ì•„ì¹´ì´ë¸Œ ğŸ¦¢<br>* . Ëš ğŸ©° * . *</p>
                        <span class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-xs text-dusty-pink transition-opacity">Click to Copy</span>
                    </div>
                </div>
            </section>

            <!-- Image Prompt Formula (Editable & Savable) -->
            <section>
                <h2 class="serif text-xl mb-4 italic text-gray-800 flex items-center">
                    <i data-lucide="image" class="w-4 h-4 mr-2 text-dusty-pink"></i> Image Master Formula
                </h2>
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <p class="text-xs text-gray-400 uppercase tracking-wider">Editable Formula</p>
                        <button onclick="resetFormula()" class="text-[10px] text-gray-400 underline hover:text-red-400">Reset to Default</button>
                    </div>
                    
                    <!-- Editable Textarea -->
                    <textarea id="master-prompt" 
                        class="w-full h-24 bg-white border border-gray-200 rounded p-3 text-sm text-gray-600 font-mono focus:outline-none focus:border-[#C5A0A0] transition-colors resize-none mb-3 leading-relaxed"
                        placeholder="í”„ë¡¬í”„íŠ¸ ê³µí†µ ì„¤ì •ê°’ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    
                    <div class="flex gap-2">
                        <button onclick="saveFormula()" class="flex-1 py-2 bg-gray-800 text-white text-xs rounded hover:bg-gray-700 transition-colors shadow-sm flex justify-center items-center">
                            <i data-lucide="save" class="w-3 h-3 mr-1"></i> Save
                        </button>
                        <button onclick="copyFormula()" class="flex-1 py-2 bg-white border border-gray-200 text-gray-500 text-xs rounded hover:text-dusty-pink hover:border-dusty-pink transition-colors flex justify-center items-center">
                            <i data-lucide="copy" class="w-3 h-3 mr-1"></i> Copy
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- Content: Caption Generator -->
        <div id="content-generator" class="hidden p-8 space-y-8 animate-fade-in">
            <div class="text-center space-y-2 mb-8">
                <h2 class="serif text-2xl italic text-gray-800">Caption Maker</h2>
                <p class="text-xs text-gray-400 font-light">Enter description, get aesthetic caption only.</p>
            </div>

            <!-- API Key Section -->
            <div class="mb-8 border border-[#E8D3D3] rounded-lg overflow-hidden">
                <button onclick="toggleApiKeySection()" class="w-full flex justify-between items-center p-3 bg-[#FDFBF7] text-xs text-gray-500 hover:bg-[#F9F3F3] transition-colors">
                    <span class="flex items-center"><i data-lucide="key" class="w-3 h-3 mr-2"></i> Google Gemini API Key ì„¤ì • (ì„ íƒ)</span>
                    <i data-lucide="chevron-down" id="api-chevron" class="w-3 h-3 transition-transform"></i>
                </button>
                <div id="apiKeySection" class="hidden bg-white p-4 border-t border-[#E8D3D3]">
                    <div class="text-[11px] text-gray-400 mb-2 leading-relaxed bg-yellow-50 p-2 rounded text-yellow-800 border border-yellow-100">
                        âš ï¸ <strong>ì£¼ì˜:</strong> í•™êµë‚˜ íšŒì‚¬ ê³„ì •ì€ ë³´ì•ˆ ë¬¸ì œë¡œ ìƒì„± ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        ì˜¤ë¥˜ ë°œìƒ ì‹œ <strong>'ê°œì¸ êµ¬ê¸€ ê³„ì •(@gmail.com)'</strong>ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì„œ ì‹œë„í•´ì£¼ì„¸ìš”.
                    </div>
                    <div class="text-[11px] text-gray-400 mb-2 mt-2 leading-relaxed">
                        API í‚¤ë¥¼ ì…ë ¥í•˜ë©´ Geminiê°€ ì§ì ‘ ê¸€ì„ ì‘ì„±í•´ì¤ë‹ˆë‹¤.<br>
                        í‚¤ê°€ ì—†ìœ¼ë©´ ë‚´ì¥ëœ ëœë¤ í…œí”Œë¦¿ì´ ì‘ë™í•©ë‹ˆë‹¤.<br>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-dusty-pink underline hover:text-gray-600">Google AI Studioì—ì„œ í‚¤ ë°œê¸‰ë°›ê¸° â†’</a>
                    </div>
                    <input type="password" id="userApiKey" placeholder="AI..." 
                        class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-xs focus:outline-none focus:border-[#C5A0A0] transition-colors">
                    <button onclick="saveApiKey()" class="mt-2 w-full py-2 bg-gray-800 text-white text-xs rounded hover:bg-gray-700 transition-colors shadow-sm">Save</button>
                </div>
            </div>

            <!-- Input Area -->
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Photo Situation / Keyword</label>
                    <input type="text" id="userInput" placeholder="ì˜ˆ: ë°œë ˆ í† ìŠˆì¦ˆ ì‚¬ì§„" 
                        class="w-full bg-[#FDFBF7] border border-gray-200 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-[#C5A0A0] transition-colors placeholder-gray-300">
                </div>
                
                <div class="flex flex-col gap-4">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1">
                            <label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Language</label>
                            <div class="flex gap-2">
                                <button onclick="setLanguage('ko')" id="lang-ko" class="flex-1 py-2 text-xs border border-[#C5A0A0] bg-[#E8D3D3] text-gray-700 rounded transition-colors">Korean</button>
                                <button onclick="setLanguage('en')" id="lang-en" class="flex-1 py-2 text-xs border border-gray-200 text-gray-400 rounded hover:bg-gray-50 transition-colors">English</button>
                            </div>
                        </div>
                        <div class="flex-1">
                             <label class="block text-xs text-gray-500 uppercase tracking-wider mb-2">Style</label>
                             <div class="flex items-center h-[34px]">
                                <input type="checkbox" id="aestheticFont" class="w-4 h-4 text-dusty-pink border-gray-300 rounded focus:ring-dusty-pink" checked>
                                <label for="aestheticFont" class="ml-2 text-xs text-gray-600 cursor-pointer select-none">âœ¨ Aesthetic Font ì ìš©</label>
                             </div>
                        </div>
                    </div>
                    <button onclick="handleGenerate()" id="generateBtn" class="w-full h-[42px] bg-gray-800 text-white text-xs tracking-wider rounded hover:bg-gray-700 transition-colors shadow-sm flex items-center justify-center">
                        GENERATE
                    </button>
                </div>
            </div>

            <!-- Output Area -->
            <div id="resultArea" class="hidden space-y-6 pt-4 border-t border-gray-100">
                <!-- Variations will be injected here -->
                <div class="space-y-2">
                    <div class="flex justify-between items-end"><span class="text-xs text-dusty-pink font-medium">Option A</span><button onclick="copyOutput('result1')" class="text-[10px] text-gray-400 hover:text-gray-600 underline">COPY</button></div>
                    <div class="bg-[#FDFBF7] p-4 rounded-lg border border-gray-100"><p id="result1" class="text-sm text-gray-700 leading-relaxed font-light whitespace-pre-wrap"></p></div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-end"><span class="text-xs text-dusty-pink font-medium">Option B</span><button onclick="copyOutput('result2')" class="text-[10px] text-gray-400 hover:text-gray-600 underline">COPY</button></div>
                    <div class="bg-[#FDFBF7] p-4 rounded-lg border border-gray-100"><p id="result2" class="text-sm text-gray-700 leading-relaxed font-light whitespace-pre-wrap"></p></div>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-end"><span class="text-xs text-dusty-pink font-medium">Option C</span><button onclick="copyOutput('result3')" class="text-[10px] text-gray-400 hover:text-gray-600 underline">COPY</button></div>
                    <div class="bg-[#FDFBF7] p-4 rounded-lg border border-gray-100"><p id="result3" class="text-sm text-gray-700 leading-relaxed font-light whitespace-pre-wrap"></p></div>
                </div>
            </div>
        </div>

        <!-- Content: Grid Planner -->
        <div id="content-grid" class="hidden p-8 space-y-8 animate-fade-in">
            <div class="text-center space-y-2 mb-8">
                <h2 class="serif text-2xl italic text-gray-800">Grid Planner</h2>
                <p class="text-xs text-gray-400 font-light">Plan your aesthetic feed. Add blocks & Delete with âŒ</p>
            </div>

            <!-- Feed Formula Tips -->
            <div class="bg-gray-50 p-5 rounded-lg border border-gray-100 mb-8">
                <h3 class="serif text-sm italic text-gray-800 flex items-center mb-3">
                    <i data-lucide="lightbulb" class="w-3 h-3 mr-2 text-dusty-pink"></i> Feed Formula
                </h3>
                <p class="text-[11px] text-gray-500 mb-4 leading-relaxed">
                    AI í‹°ê°€ ë‚˜ì§€ ì•Šê²Œ í•˜ë ¤ë©´ <strong>'ì‚¬ëŒ - ì‚¬ë¬¼ - í’ê²½'</strong>ì„ ì ì ˆíˆ ì„ì–´ì•¼ í•©ë‹ˆë‹¤.
                </p>
                
                <div class="grid grid-cols-3 gap-2 text-center mb-4">
                    <div class="space-y-1">
                        <div class="text-[10px] font-medium text-gray-600">Look</div>
                        <div class="text-[9px] text-gray-400">ì „ì‹  / ë°˜ì‹ <br>(ì–¼êµ´ ì—†ëŠ” ìƒ·)</div>
                    </div>
                    <div class="space-y-1">
                        <div class="text-[10px] font-medium text-dusty-pink">Detail</div>
                        <div class="text-[9px] text-gray-400">í† ìŠˆì¦ˆ / ë¦¬ë³¸<br>ë‹ˆíŠ¸ ì§ˆê° í™•ëŒ€</div>
                    </div>
                    <div class="space-y-1">
                        <div class="text-[10px] font-medium text-gray-500">Space</div>
                        <div class="text-[9px] text-gray-400">í–‡ì‚´ ë“  ì°½ê°€<br>ì¹¨ëŒ€ ìœ„ ì˜·ê°€ì§€</div>
                    </div>
                </div>

                <div class="bg-white p-3 rounded border border-gray-100 text-[10px] text-gray-500 leading-relaxed">
                    <strong class="text-dusty-pink">Color Tip:</strong><br>
                    í•‘í¬ìƒ‰ì´ ë„ˆë¬´ ë§ìœ¼ë©´ ì´ŒìŠ¤ëŸ¬ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    ì¤‘ê°„ì¤‘ê°„ <strong>'í°ìƒ‰/í¬ë¦¼ìƒ‰/íšŒìƒ‰'</strong> ë¹„ì¤‘ì´ ë†’ì€ ì´ë¯¸ì§€ë¥¼ ì„ì–´ì£¼ì„¸ìš”.
                </div>
            </div>

            <!-- Controls -->
            <div class="flex gap-2 justify-center mb-6">
                <button onclick="addGridItem('look')" class="flex flex-col items-center justify-center w-20 h-20 bg-white border border-gray-200 rounded-lg hover:border-[#E8D3D3] hover:shadow-sm transition-all">
                    <i data-lucide="user" class="w-5 h-5 text-gray-600 mb-1"></i>
                    <span class="text-[10px] text-gray-500">Look</span>
                </button>
                <button onclick="addGridItem('detail')" class="flex flex-col items-center justify-center w-20 h-20 bg-[#FDFBF7] border border-gray-200 rounded-lg hover:border-[#E8D3D3] hover:shadow-sm transition-all">
                    <i data-lucide="sparkles" class="w-5 h-5 text-dusty-pink mb-1"></i>
                    <span class="text-[10px] text-gray-500">Detail</span>
                </button>
                <button onclick="addGridItem('space')" class="flex flex-col items-center justify-center w-20 h-20 bg-gray-50 border border-gray-200 rounded-lg hover:border-[#E8D3D3] hover:shadow-sm transition-all">
                    <i data-lucide="sun" class="w-5 h-5 text-gray-400 mb-1"></i>
                    <span class="text-[10px] text-gray-500">Space</span>
                </button>
            </div>

            <!-- Grid Display -->
            <div id="feedGrid" class="grid grid-cols-3 gap-1 max-w-[350px] mx-auto bg-white border border-gray-100 p-1 rounded">
                <!-- Grid Items will be rendered here -->
            </div>

            <!-- Reset Button with Confirmation State -->
            <div class="text-center mt-4 mb-8">
                <button id="btnResetGrid" onclick="handleResetGrid(this)" class="text-[10px] text-gray-400 underline hover:text-red-400 transition-colors">Reset Grid</button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-[#F9F7F5] py-4 text-center border-t border-gray-100">
            <p class="text-[10px] text-gray-400 uppercase tracking-widest">Designed for dear.toe</p>
        </footer>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-6 py-3 rounded-full shadow-lg opacity-0 pointer-events-none transition-opacity duration-300">
        Copied to clipboard
    </div>

    <script>
        // Ensure Lucide is loaded
        window.addEventListener('load', function() {
            if (window.lucide) {
                lucide.createIcons();
                
                // Load saved formula
                loadFormula();
                // Load grid
                renderGrid(); 
                // Load Saved API Key
                loadApiKey();
            }
        });

        // --- Common State & Functions ---
        let currentLang = 'ko';

        function switchTab(tabName) {
            const tabs = ['guide', 'generator', 'grid'];
            tabs.forEach(t => {
                const content = document.getElementById(`content-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if (t === tabName) {
                    content.classList.remove('hidden');
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                } else {
                    content.classList.add('hidden');
                    btn.classList.add('tab-inactive');
                    btn.classList.remove('tab-active');
                }
            });
            setTimeout(() => lucide.createIcons(), 50);
        }

        function setLanguage(lang) {
            currentLang = lang;
            const btnKo = document.getElementById('lang-ko');
            const btnEn = document.getElementById('lang-en');
            if (lang === 'ko') {
                btnKo.classList.add('bg-[#E8D3D3]', 'border-[#C5A0A0]', 'text-gray-700');
                btnKo.classList.remove('text-gray-400', 'hover:bg-gray-50', 'border-gray-200');
                btnEn.classList.remove('bg-[#E8D3D3]', 'border-[#C5A0A0]', 'text-gray-700');
                btnEn.classList.add('text-gray-400', 'border-gray-200');
            } else {
                btnEn.classList.add('bg-[#E8D3D3]', 'border-[#C5A0A0]', 'text-gray-700');
                btnEn.classList.remove('text-gray-400', 'hover:bg-gray-50', 'border-gray-200');
                btnKo.classList.remove('bg-[#E8D3D3]', 'border-[#C5A0A0]', 'text-gray-700');
                btnKo.classList.add('text-gray-400', 'border-gray-200');
            }
        }

        // --- Clipboard Helper Function ---
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            textarea.style.top = '0';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) showToast("Copied to clipboard");
            } catch (err) {
                console.error('Fallback copy failed', err);
            }
            document.body.removeChild(textarea);
        }

        function copyText(element, targetId) {
            const text = document.getElementById(targetId).innerText; 
            copyToClipboard(text);
        }
        
        function copyOutput(targetId) {
            const text = document.getElementById(targetId).innerText;
            copyToClipboard(text);
        }

        function showToast(message = "Copied to clipboard") {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }

        function toggleApiKeySection() {
            const section = document.getElementById('apiKeySection');
            const chevron = document.getElementById('api-chevron');
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        // --- API Key Management ---
        const API_KEY_STORAGE = 'dearToeApiKey';

        function loadApiKey() {
            const savedKey = localStorage.getItem(API_KEY_STORAGE);
            if (savedKey) {
                document.getElementById('userApiKey').value = savedKey;
            }
        }

        function saveApiKey() {
            const key = document.getElementById('userApiKey').value.trim();
            if (!key) {
                alert("API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            localStorage.setItem(API_KEY_STORAGE, key);
            showToast("API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // --- Image Formula Storage Logic ---
        const DEFAULT_FORMULA = ", soft baby pink and vintage cream color palette, coquette balletcore aesthetic, dreamy and hazy atmosphere, soft natural lighting, nostalgic and romantic mood, delicate textures of satin and lace, pinterest style photography, --ar 4:5 --stylize 250";
        const FORMULA_STORAGE_KEY = 'dearToeFormula';

        function loadFormula() {
            const saved = localStorage.getItem(FORMULA_STORAGE_KEY);
            document.getElementById('master-prompt').value = saved || DEFAULT_FORMULA;
        }

        function saveFormula() {
            const current = document.getElementById('master-prompt').value;
            localStorage.setItem(FORMULA_STORAGE_KEY, current);
            showToast("Formula Saved");
        }

        function copyFormula() {
            const text = document.getElementById('master-prompt').value;
            copyToClipboard(text);
        }

        function resetFormula() {
            if(confirm("ê¸°ë³¸ ì„¤ì •ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                document.getElementById('master-prompt').value = DEFAULT_FORMULA;
                saveFormula();
            }
        }

        // --- Aesthetic Font Logic ---
        function toAestheticFont(text) {
            return text.split('').map(char => {
                const code = char.charCodeAt(0);
                if (code >= 65 && code <= 90) return String.fromCodePoint(0x1D434 + code - 65);
                if (code >= 97 && code <= 122) {
                    if (char === 'h') return 'â„'; 
                    return String.fromCodePoint(0x1D44E + code - 97);
                }
                return char;
            }).join('');
        }

        function applyStyle(text) {
            const useAesthetic = document.getElementById('aestheticFont').checked;
            if (!useAesthetic) return text;
            return text.split(/(\s+)/).map(word => {
                if (word.startsWith('#')) return word;
                return toAestheticFont(word);
            }).join('');
        }

        // --- Aesthetic Decorations ---
        const aestheticAtoms = [
            "ğ“‚ƒ", "Ë–", "Ë³", "Â·", "Ö´Ö¶Ö¸", "â‹†", "Ëš", "âœ§", "â‚Š", "à­¨à­§", "âŸ¡", "ï½¡", "ğœ—ğœš", "âŠ¹", "â€§", "ğ–¥”", "İ", ".", "ãƒ»", "ã‚œ", "ï¹’", "ï¼",
            "â­‘", "â™¢", "ğ“†©", "â™¡", "ğ“†ª", "â¸", "ê’°", "â£", "âº", "ê’±", "â¥", "â”ˆ", "à¼š", "à¼…", "â", "â›§", "ê™³", "â­’", "â˜ªï¸", "ï¼Š", "â˜¾", "âŸ¢", "ğŸ§‚"
        ];
        const balletEmojis = ["ğŸ©°", "ğŸ¦¢", "â˜ï¸", "ğŸ€", "ğŸ•Šï¸", "ğŸ¤", "ğŸª½", "ğŸ—ï¸", "ğŸ—ï¸", "ğŸª", "ğŸ•¯ï¸", "ğŸ°", "ğŸ", "ğŸ«§", "ğŸ§", "ğŸ§šâ€â™€ï¸", "ğŸ¹"];

        function getDecoration() {
            if (Math.random() > 0.5) {
                const length = Math.floor(Math.random() * 3) + 2; 
                let result = "";
                for (let i = 0; i < length; i++) {
                    result += aestheticAtoms[Math.floor(Math.random() * aestheticAtoms.length)];
                    if (Math.random() > 0.7) result += " ";
                }
                return result.trim();
            } else {
                return balletEmojis[Math.floor(Math.random() * balletEmojis.length)];
            }
        }

        // --- Grid Planner Logic ---
        const GRID_STORAGE_KEY = 'dearToeGrid';
        let resetTimeout; 
        
        function getGrid() {
            const saved = localStorage.getItem(GRID_STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
        }

        function saveGrid(grid) {
            localStorage.setItem(GRID_STORAGE_KEY, JSON.stringify(grid));
            renderGrid();
        }

        function addGridItem(type) {
            const grid = getGrid();
            
            const subtitles = {
                'look': [
                    "ì „ì‹  (ì–¼êµ´X)", "ë°˜ì‹  (ê±°ìš¸ ì…€ì¹´)", "ë’·ëª¨ìŠµ (ë“± ë¼ì¸)", "ì•‰ì•„ìˆëŠ” í¬ì¦ˆ", "ìŠ¤íŠ¸ë ˆì¹­ (ë‹¤ë¦¬)", 
                    "ì†ë ë””í…Œì¼", "ëª©ì„ /ì‡„ê³¨ ë¼ì¸", "ë°œë ˆ bun í—¤ì–´", "ë°œë ˆë°” ì¡ê³ ", "í”Œë¦¬ì— ë™ì‘"
                ],
                'detail': [
                    "í† ìŠˆì¦ˆ (ë¦¬ë³¸ ë¬¶ê¸°)", "ìƒˆí‹´ ì§ˆê° í™•ëŒ€", "ë°œë ˆ ìŠ¤ì»¤íŠ¸ (íŠ¤)", "ë ˆì˜¤íƒ€ë“œ ëˆ ë””í…Œì¼", 
                    "ë‹ˆíŠ¸ ì›Œë¨¸ ì£¼ë¦„", "ë²—ì–´ë‘” í† ìŠˆì¦ˆ", "ì•…ì„¸ì‚¬ë¦¬ (ì§„ì£¼/ë¦¬ë³¸)", "ì‰¬í° ì†Œì¬ê°", 
                    "í† ìŠˆì¦ˆ ëˆ í’€ë¦°", "ë•€ë°©ìš¸ ë””í…Œì¼"
                ],
                'space': [
                    "í–‡ì‚´ ë“  ì—°ìŠµì‹¤", "ë‚˜ë¬´ ë°”ë‹¥/í”Œë¡œì–´", "ì°½ê°€ ì»¤íŠ¼", "ì¹¨ëŒ€ ìœ„ ì˜·ê°€ì§€", "ë°œë ˆë°” (Barre)", 
                    "ê±°ìš¸ ì† í’ê²½", "ë¹ˆ ì˜ì", "ê½ƒë³‘ê³¼ ë¹›", "í† ìŠˆì¦ˆ ê°€ë°©", "ì—°ìŠµì‹¤ êµ¬ì„"
                ]
            };

            const pool = subtitles[type] || [];
            const randomSubtitle = pool.length > 0 ? pool[Math.floor(Math.random() * pool.length)] : "";

            const newItem = {
                id: Date.now(),
                type: type,
                subtitle: randomSubtitle,
                timestamp: new Date().toISOString()
            };
            grid.unshift(newItem);
            saveGrid(grid);
        }

        function removeGridItem(id) {
            const grid = getGrid();
            const newGrid = grid.filter(item => item.id !== id);
            saveGrid(newGrid);
        }

        function handleResetGrid(btn) {
            if (btn.innerText === "Confirm Reset?") {
                localStorage.removeItem(GRID_STORAGE_KEY);
                renderGrid();
                btn.innerText = "Reset Grid";
                btn.classList.remove('text-red-500', 'font-bold');
                clearTimeout(resetTimeout);
            } else {
                btn.innerText = "Confirm Reset?";
                btn.classList.add('text-red-500', 'font-bold');
                resetTimeout = setTimeout(() => {
                    btn.innerText = "Reset Grid";
                    btn.classList.remove('text-red-500', 'font-bold');
                }, 3000);
            }
        }

        function renderGrid() {
            const grid = getGrid();
            const container = document.getElementById('feedGrid');
            
            if (grid.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 py-10 text-center text-gray-300 text-xs">
                        <i data-lucide="layout-grid" class="w-6 h-6 mx-auto mb-2 opacity-30"></i>
                        Empty Grid<br>Add blocks to plan
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = grid.map(item => {
                let icon, bgColor, label;
                switch(item.type) {
                    case 'look': icon = 'user'; bgColor = 'bg-white'; label = 'Look'; break;
                    case 'detail': icon = 'sparkles'; bgColor = 'bg-[#E8D3D3]/20'; label = 'Detail'; break;
                    case 'space': icon = 'sun'; bgColor = 'bg-gray-50'; label = 'Space'; break;
                }
                
                return `
                    <div class="relative aspect-[4/5] ${bgColor} border border-gray-100 flex flex-col items-center justify-center group cursor-pointer grid-item-enter hover:opacity-90 transition-opacity" onclick="removeGridItem(${item.id})">
                        <i data-lucide="${icon}" class="w-4 h-4 text-gray-400 mb-1"></i>
                        <span class="text-[9px] text-gray-500 font-medium uppercase tracking-wider">${label}</span>
                        <span class="text-[8px] text-gray-400 mt-1">${item.subtitle || ''}</span>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        // --- Generator Logic ---
        function getRandomTags() {
            const baseTags = "#ë°œë ˆ #ballet";
            const tagPool = ["#dear_toe", "#ë°œë ˆì½”ì–´", "#ì·¨ë¯¸ë°œë ˆ", "#ë°œë ˆìŠ¤íƒ€ê·¸ë¨", "#í† ìŠˆì¦ˆ", "#ê°ì„±ì‚¬ì§„", "#ë¬´ë“œë³´ë“œ", "#balletcore", "#balletaesthetic", "#softgirl", "#dreamyaesthetic", "#ë ˆì˜¤íƒ€ë“œ", "#ootd"];
            const shuffled = tagPool.sort(() => 0.5 - Math.random());
            return `${baseTags} ${shuffled.slice(0, 4).join(' ')}`;
        }

        function generateWithTemplate(input) {
            const tags = getRandomTags();
            let opt1, opt2, opt3;

            if (currentLang === 'ko') {
                const phrases = ["En pointe.", "ì˜¤í›„ì˜ ë³•.", "Grand PliÃ©.", "ì·¨í–¥ì˜ ì¡°ê°.", "Port de bras.", "ê°€ë³ê²Œ.", "Tendu.", "Arabesque line.", "Satin mood.", "ê³µê¸° ê°™ì€ íŠ¤.", "Ethereal.", "ë‚˜ë§Œì˜ í˜¸í¡.", "ìš°ì•„í•œ ì •ì .", "Silhouette.", "Adagio."];
                const phrase = phrases[Math.floor(Math.random() * phrases.length)];
                
                // Only output the phrase/vibe, NOT the input text
                const raw1 = phrase;
                const raw2 = `ë‹´ë°±í•˜ê²Œ.`;
                const raw3 = `ì¤‘ì‹¬.`;

                opt1 = `${applyStyle(raw1)} ${getDecoration()}\n.\n${tags}`;
                opt2 = `${applyStyle(raw2)} ${getDecoration()}\n.\n${tags}`;
                opt3 = `${applyStyle(raw3)} ${getDecoration()}\n.\n${tags}`;
            } else {
                const phrases = ["Soft layers.", "En pointe.", "Silence.", "Mood.", "Grand PliÃ©.", "Morning light.", "Pure lines.", "Tendu.", "Satin mood.", "Ethereal.", "Tulle dreams.", "Graceful.", "Adagio.", "Swan lake.", "Ballerina soul."];
                const phrase = phrases[Math.floor(Math.random() * phrases.length)];
                
                const raw1 = phrase;
                const raw2 = `Satin mood.`;
                const raw3 = `Attitude.`;

                opt1 = `${applyStyle(raw1)} ${getDecoration()}\n.\n${tags}`;
                opt2 = `${applyStyle(raw2)} ${getDecoration()}\n.\n${tags}`;
                opt3 = `${applyStyle(raw3)} ${getDecoration()}\n.\n${tags}`;
            }

            document.getElementById('result1').innerText = opt1;
            document.getElementById('result2').innerText = opt2;
            document.getElementById('result3').innerText = opt3;
        }

        async function generateWithAI(input, apiKey) {
            const langInstruction = currentLang === 'ko' ? "Use Korean." : "Use English.";
            const systemPrompt = `You are the editor of 'dear.toe', an aesthetic ballet archive Instagram account. Tone: Dry, Chic, Minimalist but dreamy. Rules: Use 1-2 emojis (e.g. ğŸ©°, ğŸ¦¢, â˜ï¸, ğŸ€, ğŸª½) OR 1-2 aesthetic symbols (e.g. ğ–¥”, İ, Ë–, Ë³, ğ“‚ƒ, ğœ—ğœš, ğ“†©â™¡ğ“†ª, â˜ªï¸). STRICT RULE: Do NOT mix standard emojis with aesthetic symbols in the same caption. Use ONE type or the other. Short (2-3 lines). No greetings. ${langInstruction}. STRICT RULE: Do NOT mix languages in the caption text. Use proper ballet terminology (e.g., PliÃ©, Tendu, Arabesque, Pointe, Satin, Ribbon, Tulle, Ethereal, Adagio, Silhouette) instead of generic words like 'dance' or 'shoes'. IMPORTANT: Do NOT repeat the user's input description in the output. Use it only as context to generate a mood/keyword. (Hashtags are handled separately, so just generate the text). Provide 3 distinct options separated by '|||'. Input description: ${input}`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: `${systemPrompt}\n\nGenerate 3 options.` }] }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const rawText = data.candidates[0].content.parts[0].text;
            const options = rawText.split('|||');
            const tags = getRandomTags();
            const clean = (text) => text ? text.replace(/\*\*/g, '').trim() : "AI Error";

            document.getElementById('result1').innerText = applyStyle(clean(options[0])) + `\n.\n${tags}`;
            document.getElementById('result2').innerText = applyStyle(clean(options[1] || options[0])) + `\n.\n${tags}`;
            document.getElementById('result3').innerText = applyStyle(clean(options[2] || options[0])) + `\n.\n${tags}`;
        }

        async function handleGenerate() {
            const input = document.getElementById('userInput').value.trim();
            const apiKey = document.getElementById('userApiKey').value.trim();
            const btn = document.getElementById('generateBtn');
            const resultArea = document.getElementById('resultArea');
            
            if (!input) {
                alert("í‚¤ì›Œë“œë‚˜ ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;

            try {
                if (apiKey) {
                    await generateWithAI(input, apiKey);
                } else {
                    generateWithTemplate(input);
                }
                resultArea.classList.remove('hidden');
            } catch (error) {
                console.error(error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            } finally {
                btn.innerHTML = 'GENERATE';
                btn.disabled = false;
            }
        }

        document.getElementById('userInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') handleGenerate();
        });
    </script>
</body>
</html>
